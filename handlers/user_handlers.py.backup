import asyncio
import datetime
import os
import sys

import aiogram.exceptions

# –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Ç—å –∫ –∫–æ—Ä–Ω–µ–≤–æ–π –ø–∞–ø–∫–µ –ø—Ä–æ–µ–∫—Ç–∞
current_dir = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
if current_dir not in sys.path:
    sys.path.append(current_dir)

from aiogram import F, Router
from aiogram.types import Message, CallbackQuery
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton
from aiogram.fsm.context import FSMContext
from aiogram.filters import Command
import logging

from states.user_states import RegistrationStates, FeedbackStates
from keyboards.user_kb import (
    get_main_keyboard,
    get_cancel_keyboard,
    get_confirmation_keyboard,
    get_courses_keyboard,
    get_training_types_keyboard,
    get_schedule_keyboard,
    get_cabinet_keyboard,
    get_materials_keyboard,
    get_quiz_keyboard,
    get_feedback_types_keyboard,
    get_rating_keyboard,
    get_feedback_confirmation_keyboard,
    get_progress_keyboard,
    get_quiz_results_keyboard,
    get_registrations_keyboard,
    get_registration_detail_keyboard,
    get_back_keyboard, get_quiz_answer_keyboard, get_quiz_question_keyboard
)
from utils.validators import validate_name, validate_phone, format_phone
from config import Config
from helpers import get_db  # ‚úÖ –î–û–ë–ê–í–õ–ï–ù –ò–ú–ü–û–†–¢!

user_router = Router(name="user_router")
config = Config()
db = get_db()
logger = logging.getLogger(__name__)


# –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
@user_router.message(Command("start"))
async def start_command(message: Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start"""
    await message.answer(
        "üéì –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π —Ü–µ–Ω—Ç—Ä!\n\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
        reply_markup=get_main_keyboard()
    )


@user_router.message(Command("help"))
async def help_command(message: Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /help"""
    await message.answer(
        "üìñ *–ü–æ–º–æ—â—å –ø–æ –±–æ—Ç—É:*\n\n"
        "üéì *–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:*\n"
        "‚Ä¢ üìù –ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å - –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫—É—Ä—Å\n"
        "‚Ä¢ üë§ –ú–æ–π –∫–∞–±–∏–Ω–µ—Ç - –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç\n"
        "‚Ä¢ üìö –ö—É—Ä—Å—ã - —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫—É—Ä—Å–æ–≤\n"
        "‚Ä¢ ‚ÑπÔ∏è –û —Ü–µ–Ω—Ç—Ä–µ - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –Ω–∞—Å\n"
        "‚Ä¢ üí¨ –û—Ç–∑—ã–≤ - –æ—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤\n\n"
        "üìû *–ü–æ–¥–¥–µ—Ä–∂–∫–∞:*\n"
        "–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–ª–∏ –≤–æ–ø—Ä–æ—Å—ã, —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –Ω–∞–º–∏!",
        parse_mode="Markdown",
        reply_markup=get_main_keyboard()
    )


@user_router.callback_query(F.data == "new_registration")
async def start_new_registration(callback: CallbackQuery, state: FSMContext):
    """–ù–∞—á–∞—Ç—å –Ω–æ–≤—É—é —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –Ω–∞ –∫—É—Ä—Å"""
    await state.clear()
    await state.set_state(RegistrationStates.choosing_course)

    await callback.message.edit_text(
        "üéì *–ó–∞–ø–∏—Å—å –Ω–∞ –∫—É—Ä—Å*\n\n–í—ã–±–µ—Ä–∏—Ç–µ –∫—É—Ä—Å:",
        parse_mode="Markdown",
        reply_markup=get_courses_keyboard()
    )
    await callback.answer()


@user_router.callback_query(F.data == "about_center")
async def about_center(callback: CallbackQuery):
    about_text = (
        "üè´ *–û –Ω–∞—à–µ–º —Ü–µ–Ω—Ç—Ä–µ:*\n\n"
        "–ú—ã –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –ø–æ —Ä–∞–∑–ª–∏—á–Ω—ã–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º.\n\n"
        "üìû *–ö–æ–Ω—Ç–∞–∫—Ç—ã:*\n"
        "–¢–µ–ª–µ—Ñ–æ–Ω: +7 (XXX) XXX-XX-XX\n"
        "–ê–¥—Ä–µ—Å: –í–∞—à –∞–¥—Ä–µ—Å\n\n"
        "üïí *–ß–∞—Å—ã —Ä–∞–±–æ—Ç—ã:*\n"
        "–ü–Ω-–ü—Ç: 9:00-18:00\n"
        "–°–±: 10:00-15:00\n"
        "–í—Å: –≤—ã—Ö–æ–¥–Ω–æ–π"
    )
    await callback.message.edit_text(
        about_text,
        parse_mode="Markdown",
        reply_markup=get_main_keyboard()
    )
    await callback.answer()


# –ü—Ä–æ—Ü–µ—Å—Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
@user_router.callback_query(F.data == "show_courses")
async def show_courses(callback: CallbackQuery):
    """–ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ –∫—É—Ä—Å–æ–≤"""
    courses_text = "üéì *–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫—É—Ä—Å—ã:*\n\n"

    for course, types_dict in config.COURSES.items():
        courses_text += f"*{course}:*\n"
        for training_type, price in types_dict.items():
            courses_text += f"  ‚Ä¢ {training_type}: {price}\n"
        courses_text += "\n"
        await callback.message.edit_text(
            courses_text,
            parse_mode="Markdown",
            reply_markup=get_back_keyboard("back_to_main")
        )
    await callback.answer()


@user_router.callback_query(F.data.startswith("course_"), RegistrationStates.choosing_course)
async def choose_course(callback: CallbackQuery, state: FSMContext):
    """–í—ã–±–æ—Ä –∫—É—Ä—Å–∞"""
    try:
        course_idx = int(callback.data.replace("course_", ""))
        courses_list = list(config.COURSES.keys())

        if 0 <= course_idx < len(courses_list):
            course = courses_list[course_idx]
            await state.update_data(course=course, course_idx=course_idx)
            await state.set_state(RegistrationStates.choosing_training_type)

            await callback.message.edit_text(
                f"üéì *–ö—É—Ä—Å: {course}*\n\n–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –æ–±—É—á–µ–Ω–∏—è:",
                parse_mode="Markdown",
                reply_markup=get_training_types_keyboard(course_idx)
            )
        else:
            await callback.answer("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –∫—É—Ä—Å", show_alert=True)

    except ValueError as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤—ã–±–æ—Ä–∞ –∫—É—Ä—Å–∞: {e}")
        await callback.answer("‚ùå –û—à–∏–±–∫–∞ –≤—ã–±–æ—Ä–∞ –∫—É—Ä—Å–∞", show_alert=True)

    await callback.answer()


@user_router.callback_query(F.data.startswith("type_"), RegistrationStates.choosing_training_type)
async def choose_training_type(callback: CallbackQuery, state: FSMContext):
    """–í—ã–±–æ—Ä —Ç–∏–ø–∞ –æ–±—É—á–µ–Ω–∏—è"""
    try:
        data_parts = callback.data.split("_")
        if len(data_parts) >= 3:
            course_idx = int(data_parts[1])
            type_idx = int(data_parts[2])

            courses_list = list(config.COURSES.keys())
            if 0 <= course_idx < len(courses_list):
                course = courses_list[course_idx]
                training_types = list(config.COURSES[course].keys())

                if 0 <= type_idx < len(training_types):
                    training_type = training_types[type_idx]
                    price = config.COURSES[course][training_type]

                    await state.update_data(
                        training_type=training_type,
                        price=price
                    )
                    await state.set_state(RegistrationStates.choosing_schedule)

                    await callback.message.edit_text(
                        f"üìä *–¢–∏–ø –æ–±—É—á–µ–Ω–∏—è: {training_type}*\n"
                        f"üí∞ *–°—Ç–æ–∏–º–æ—Å—Ç—å: {price}*\n\n"
                        "–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ:",
                        parse_mode="Markdown",
                        reply_markup=get_schedule_keyboard()
                    )

    except (ValueError, IndexError) as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞ –æ–±—É—á–µ–Ω–∏—è: {e}")
        await callback.answer("‚ùå –û—à–∏–±–∫–∞ –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞ –æ–±—É—á–µ–Ω–∏—è", show_alert=True)

    await callback.answer()


@user_router.callback_query(F.data.startswith("schedule_"), RegistrationStates.choosing_schedule)
async def choose_schedule(callback: CallbackQuery, state: FSMContext):
    """–í—ã–±–æ—Ä —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è"""
    try:
        schedule_idx = int(callback.data.replace("schedule_", ""))

        if 0 <= schedule_idx < len(config.SCHEDULES):
            schedule = config.SCHEDULES[schedule_idx]
            await state.update_data(schedule=schedule)
            await state.set_state(RegistrationStates.waiting_for_name)

            await callback.message.edit_text(
                "üë§ *–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è –∏ —Ñ–∞–º–∏–ª–∏—é:*\n\n"
                "–ù–∞–ø—Ä–∏–º–µ—Ä: –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤",
                parse_mode="Markdown",
                reply_markup=get_cancel_keyboard()
            )
        else:
            await callback.answer("‚ùå –ù–µ–≤–µ—Ä–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ", show_alert=True)

    except ValueError as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤—ã–±–æ—Ä–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è: {e}")
        await callback.answer("‚ùå –û—à–∏–±–∫–∞ –≤—ã–±–æ—Ä–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è", show_alert=True)

    await callback.answer()


@user_router.message(RegistrationStates.waiting_for_name)
async def get_name(message: Message, state: FSMContext):
    """–ü–æ–ª—É—á–µ–Ω–∏–µ –∏–º–µ–Ω–∏"""
    if message.text == "‚ùå –û—Ç–º–µ–Ω–∞":
        await state.clear()
        await message.answer("–û—Ç–º–µ–Ω–µ–Ω–æ.", reply_markup=get_main_keyboard())
        return

    is_valid, error_msg = validate_name(message.text)
    if not is_valid:
        await message.answer(
            f"‚ùå {error_msg}\n\n–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∏–º—è –µ—â–µ —Ä–∞–∑:",
            reply_markup=get_cancel_keyboard()
        )
        return

    await state.update_data(name=message.text)
    await state.set_state(RegistrationStates.waiting_for_phone)

    await message.answer(
        "üìû *–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞:*\n\n"
        "–ù–∞–ø—Ä–∏–º–µ—Ä: +998901234567",
        parse_mode="Markdown",
        reply_markup=get_cancel_keyboard()
    )


@user_router.message(RegistrationStates.waiting_for_phone)
async def get_phone(message: Message, state: FSMContext):
    """–ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–ª–µ—Ñ–æ–Ω–∞"""
    if message.text == "‚ùå –û—Ç–º–µ–Ω–∞":
        await state.clear()
        await message.answer("–û—Ç–º–µ–Ω–µ–Ω–æ.", reply_markup=get_main_keyboard())
        return

    is_valid, error_msg = validate_phone(message.text)
    if not is_valid:
        await message.answer(
            f"‚ùå {error_msg}\n\n–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –µ—â–µ —Ä–∞–∑:",
            reply_markup=get_cancel_keyboard()
        )
        return

    formatted_phone = format_phone(message.text)
    await state.update_data(phone=formatted_phone)
    data = await state.get_data()

    confirmation_text = (
        "‚úÖ *–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ:*\n\n"
        f"üë§ *–ò–º—è:* {data['name']}\n"
        f"üìû *–¢–µ–ª–µ—Ñ–æ–Ω:* `{formatted_phone}`\n"
        f"üéØ *–ö—É—Ä—Å:* {data['course']}\n"
        f"üìä *–¢–∏–ø –æ–±—É—á–µ–Ω–∏—è:* {data['training_type']}\n"
        f"‚è∞ *–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ:* {data['schedule']}\n"
        f"üí∞ *–°—Ç–æ–∏–º–æ—Å—Ç—å:* {data['price']}\n\n"
        "–í—Å—ë –≤–µ—Ä–Ω–æ?"
    )

    await state.set_state(RegistrationStates.confirmation)
    await message.answer(
        confirmation_text,
        parse_mode="Markdown",
        reply_markup=get_confirmation_keyboard()
    )


@user_router.callback_query(F.data == "confirm_registration", RegistrationStates.confirmation)
async def confirm_registration(callback: CallbackQuery, state: FSMContext):
    """–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏"""
    try:
        data = await state.get_data()

        print(f"üîç DEBUG: Starting registration confirmation for user {callback.from_user.id}")
        print(f"üîç DEBUG: Registration data: {data}")

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é
        from helpers import get_db

        db = get_db()

        # –°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–µ–º/–Ω–∞—Ö–æ–¥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        user_query = """
                     INSERT \
                     OR IGNORE INTO users (telegram_id, full_name, phone)
            VALUES (?, ?, ?) \
                     """
        db.execute_update(user_query, (
            callback.from_user.id,
            data['name'],
            data['phone']
        ))

        # –ü–æ–ª—É—á–∞–µ–º user_id
        user_query = "SELECT id FROM users WHERE telegram_id = ?"
        user_rows = db.execute_query(user_query, (callback.from_user.id,))
        user_id = user_rows[0]['id'] if user_rows else None

        if not user_id:
            await callback.message.edit_text("‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è")
            return

        # –ü–æ–ª—É—á–∞–µ–º ID –∫—É—Ä—Å–∞ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é
        course_query = "SELECT id FROM courses WHERE name = ?"
        course_rows = db.execute_query(course_query, (data['course'],))
        course_id = course_rows[0]['id'] if course_rows else 1  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø–µ—Ä–≤—ã–π –∫—É—Ä—Å

        # –ü–æ–ª—É—á–∞–µ–º ID —Ç–∏–ø–∞ –æ–±—É—á–µ–Ω–∏—è
        training_query = "SELECT id FROM training_types WHERE name = ?"
        training_rows = db.execute_query(training_query, (data['training_type'],))
        training_type_id = training_rows[0]['id'] if training_rows else 1

        # –ü–æ–ª—É—á–∞–µ–º ID —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
        schedule_query = "SELECT id FROM schedules WHERE name = ?"
        schedule_rows = db.execute_query(schedule_query, (data['schedule'],))
        schedule_id = schedule_rows[0]['id'] if schedule_rows else 1

        # –°–æ–∑–¥–∞–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é
        reg_id = db.registrations.create(
            user_id=user_id,
            course_id=course_id,
            training_type_id=training_type_id,
            schedule_id=schedule_id,
            status='active'
        )

        success = reg_id is not None

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: {e}", exc_info=True)
        print(f"‚ùå DEBUG: Exception in confirm_registration: {e}")
        await callback.message.edit_text(
            "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.",
            reply_markup=get_main_keyboard()
        )
        await state.clear()
        await callback.answer()


async def send_registration_to_admins(bot, data, user):
    """–û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–æ–≤–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º"""
    try:
        message_text = (
            "üÜï *–ù–û–í–ê–Ø –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø!*\n\n"
            f"üë§ *–ò–º—è:* {data['name']}\n"
            f"üìû *–¢–µ–ª–µ—Ñ–æ–Ω:* {data['phone']}\n"
            f"üÜî *Telegram ID:* {user.id}\n"
            f"üìù *Username:* @{user.username or '–Ω–µ —É–∫–∞–∑–∞–Ω'}\n\n"
            f"üéì *–ö—É—Ä—Å:* {data['course']}\n"
            f"üìä *–¢–∏–ø –æ–±—É—á–µ–Ω–∏—è:* {data['training_type']}\n"
            f"‚è∞ *–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ:* {data['schedule']}\n"
            f"üí∞ *–°—Ç–æ–∏–º–æ—Å—Ç—å:* {data['price']}\n\n"
            f"üïí *–í—Ä–µ–º—è:* {datetime.datetime.now().strftime('%d.%m.%Y %H:%M')}"
        )

        for admin_id in config.ADMIN_IDS:
            try:
                await bot.send_message(admin_id, message_text, parse_mode="Markdown")
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É {admin_id}: {e}")

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ send_registration_to_admins: {e}")


@user_router.callback_query(F.data == "leave_feedback")
async def show_feedback_menu(callback: CallbackQuery, state: FSMContext):
    """–ü–æ–∫–∞–∑–∞—Ç—å –º–µ–Ω—é –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏"""
    await state.clear()

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
    await state.update_data(
        user_id=callback.from_user.id,
        user_name=callback.from_user.full_name or callback.from_user.username or "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"
    )

    await callback.message.edit_text(
        "üí¨ *–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å*\n\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –æ–±—Ä–∞—â–µ–Ω–∏—è:",
        parse_mode="Markdown",
        reply_markup=get_feedback_types_keyboard()
    )
    await callback.answer()


@user_router.callback_query(F.data.in_(["feedback_review", "feedback_suggestion", "feedback_issue"]))
async def handle_feedback_type(callback: CallbackQuery, state: FSMContext):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏"""
    feedback_types = {
        "feedback_review": "review",
        "feedback_suggestion": "suggestion",
        "feedback_issue": "issue"
    }

    feedback_type = feedback_types[callback.data]
    await state.update_data(feedback_type=feedback_type)

    if feedback_type == "review":
        await state.set_state(FeedbackStates.waiting_for_rating)
        await callback.message.edit_text(
            "‚≠ê *–û—Ü–µ–Ω–∏—Ç–µ –Ω–∞—à –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π —Ü–µ–Ω—Ç—Ä*\n\n"
            "–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ü–µ–Ω–∫—É –æ—Ç 1 –¥–æ 5 –∑–≤–µ–∑–¥:",
            parse_mode="Markdown",
            reply_markup=get_rating_keyboard()
        )
    else:
        await state.set_state(FeedbackStates.waiting_for_feedback_text)
        prompts = {
            "suggestion": "üí° *–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é*\n\n–ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ:",
            "issue": "üêû *–°–æ–æ–±—â–µ–Ω–∏–µ –æ –ø—Ä–æ–±–ª–µ–º–µ*\n\n–û–ø–∏—à–∏—Ç–µ –≤–æ–∑–Ω–∏–∫—à—É—é –ø—Ä–æ–±–ª–µ–º—É:"
        }
        await callback.message.edit_text(
            prompts[feedback_type],
            parse_mode="Markdown",
            reply_markup=get_cancel_keyboard()
        )

    await callback.answer()


@user_router.callback_query(F.data.startswith("rating_"), FeedbackStates.waiting_for_rating)
async def get_rating(callback: CallbackQuery, state: FSMContext):
    """–ü–æ–ª—É—á–µ–Ω–∏–µ –æ—Ü–µ–Ω–∫–∏"""
    rating = int(callback.data.replace("rating_", ""))
    await state.update_data(rating=rating)
    await state.set_state(FeedbackStates.waiting_for_feedback_text)

    await callback.message.edit_text(
        f"üìù *–ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –æ—Ç–∑—ã–≤*\n\n"
        f"–í—ã –≤—ã–±—Ä–∞–ª–∏ –æ—Ü–µ–Ω–∫—É: {'‚≠ê' * rating}\n\n"
        "–¢–µ–ø–µ—Ä—å –Ω–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –æ—Ç–∑—ã–≤ –æ —Ü–µ–Ω—Ç—Ä–µ:",
        parse_mode="Markdown",
        reply_markup=get_cancel_keyboard()
    )
    await callback.answer()


@user_router.message(FeedbackStates.waiting_for_feedback_text)
async def get_feedback_text(message: Message, state: FSMContext):
    """–ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏"""
    if message.text == "‚ùå –û—Ç–º–µ–Ω–∞":
        await state.clear()
        await message.answer("–û—Ç–º–µ–Ω–µ–Ω–æ.", reply_markup=get_main_keyboard())
        return

    data = await state.get_data()
    await state.update_data(feedback_text=message.text)

    type_names = {
        "review": "–û—Ç–∑—ã–≤",
        "suggestion": "–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ",
        "issue": "–°–æ–æ–±—â–µ–Ω–∏–µ –æ –ø—Ä–æ–±–ª–µ–º–µ"
    }

    confirmation_text = "üìã *–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–∞—à–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ:*\n\n"
    confirmation_text += f"üìù *–¢–∏–ø:* {type_names[data['feedback_type']]}\n"

    if data['feedback_type'] == 'review':
        confirmation_text += f"‚≠ê *–û—Ü–µ–Ω–∫–∞:* {data['rating']}/5\n"

    confirmation_text += f"üìÑ *–¢–µ–∫—Å—Ç:*\n{message.text}\n\n–í—Å—ë –≤–µ—Ä–Ω–æ?"

    await message.answer(
        confirmation_text,
        parse_mode="Markdown",
        reply_markup=get_feedback_confirmation_keyboard()
    )


@user_router.callback_query(F.data == "feedback_send")
async def send_feedback(callback: CallbackQuery, state: FSMContext):
    """–û—Ç–ø—Ä–∞–≤–∫–∞ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏"""
    try:
        data = await state.get_data()

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ë–î
        success = db.save_feedback(
            user_id=data['user_id'],
            user_name=data['user_name'],
            feedback_type=data['feedback_type'],
            feedback_text=data['feedback_text'],
            rating=data.get('rating'),
            created_at=datetime.datetime.now()
        )

        if success:
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º
            await send_feedback_to_admins(callback.bot, data)

            await callback.message.edit_text(
                "‚úÖ *–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à—É –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å!*\n\n"
                "–ú—ã —Ü–µ–Ω–∏–º –≤–∞—à–µ –º–Ω–µ–Ω–∏–µ –∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Ä–∞—Å—Å–º–æ—Ç—Ä–∏–º –≤–∞—à–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ.",
                parse_mode="Markdown",
                reply_markup=get_main_keyboard()
            )
        else:
            await callback.message.edit_text(
                "‚ùå *–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞*\n\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.",
                parse_mode="Markdown",
                reply_markup=get_main_keyboard()
            )

        await state.clear()
        await callback.answer()

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ feedback: {e}", exc_info=True)
        await callback.message.edit_text(
            "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞",
            reply_markup=get_main_keyboard()
        )
        await state.clear()
        await callback.answer()


@user_router.callback_query(F.data == "feedback_edit")
async def edit_feedback(callback: CallbackQuery, state: FSMContext):
    """–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏"""
    await state.set_state(FeedbackStates.waiting_for_feedback_text)

    await callback.message.edit_text(
        "üìù *–ò—Å–ø—Ä–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç:*\n\n"
        "–ù–∞–ø–∏—à–∏—Ç–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç:",
        parse_mode="Markdown",
        reply_markup=get_cancel_keyboard()
    )
    await callback.answer()


async def send_feedback_to_admins(bot, feedback_data):
    """–û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ feedback –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º"""
    try:
        type_names = {
            "review": "üìù –ù–û–í–´–ô –û–¢–ó–´–í",
            "suggestion": "üí° –ù–û–í–û–ï –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï",
            "issue": "üêû –°–û–û–ë–©–ï–ù–ò–ï –û –ü–†–û–ë–õ–ï–ú–ï"
        }

        message_text = (
            f"{type_names[feedback_data['feedback_type']]}\n\n"
            f"üë§ *–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:* {feedback_data['user_name']}\n"
            f"üÜî *ID:* {feedback_data['user_id']}\n"
        )

        if feedback_data['feedback_type'] == 'review':
            message_text += f"‚≠ê *–û—Ü–µ–Ω–∫–∞:* {feedback_data['rating']}/5\n"

        message_text += (
            f"üìÑ *–¢–µ–∫—Å—Ç:*\n{feedback_data['feedback_text']}\n\n"
            f"üïí *–í—Ä–µ–º—è:* {datetime.datetime.now().strftime('%d.%m.%Y %H:%M')}"
        )

        for admin_id in config.ADMIN_IDS:
            try:
                await bot.send_message(admin_id, message_text, parse_mode="Markdown")
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É {admin_id}: {e}")

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ send_feedback_to_admins: {e}")


# –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –∫–∞–±–∏–Ω–µ—Ç–∞
@user_router.callback_query(F.data == "show_cabinet")
async def show_cabinet(callback: CallbackQuery):
    registrations = db.get_user_registrations(callback.from_user.id)
    if not registrations:
        await callback.message.edit_text(
            "–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π.\n\n–•–æ—Ç–∏—Ç–µ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫—É—Ä—Å? –ù–∞–∂–º–∏—Ç–µ ¬´üìù –ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å¬ª!",
            reply_markup=get_main_keyboard()
        )
        return

    for reg in registrations:
        cabinet_text = (
            f"üìã *–í–∞—à–∞ –∑–∞–ø–∏—Å—å #{reg.id}:*\n\n"
            f"üéØ *–ö—É—Ä—Å:* {reg.course}\n"
            f"üìä *–¢–∏–ø:* {reg.training_type}\n"
            f"‚è∞ *–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ:* {reg.schedule}\n"
            f"üí∞ *–°—Ç–æ–∏–º–æ—Å—Ç—å:* {reg.price}\n"
            f"üìÖ *–î–∞—Ç–∞ –∑–∞–ø–∏—Å–∏:* {reg.created_at}\n"
        )
        await callback.message.answer(cabinet_text, parse_mode="Markdown")

    await callback.message.answer("–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:", reply_markup=get_cabinet_keyboard())
    await callback.answer()


@user_router.callback_query(F.data == "show_materials")
async def show_materials(callback: CallbackQuery):
    registrations = db.get_user_registrations(callback.from_user.id)

    if not registrations:
        await callback.message.edit_text("–£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫—É—Ä—Å–æ–≤.", reply_markup=get_main_keyboard())
        return

    course = registrations[0].course
    await callback.message.edit_text(
        f"üìö –ú–∞—Ç–µ—Ä–∏–∞–ª—ã –ø–æ –∫—É—Ä—Å—É {course}:",
        reply_markup=get_materials_keyboard(course)
    )
    await callback.answer()


@user_router.callback_query(F.data == "add_reminder")
async def add_reminder_start(callback: CallbackQuery):
    """–ù–∞—á–∞–ª–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è"""
    await callback.message.edit_text(
        "‚è∞ *–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è*\n\n"
        "–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è:",
        parse_mode="Markdown",
        reply_markup=get_cancel_keyboard()
    )


@user_router.callback_query(F.data == "show_reminders")
async def show_reminders(callback: CallbackQuery):
    """–ü–æ–∫–∞–∑–∞—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    reminders = db.get_user_reminders(callback.from_user.id)

    if not reminders:
        await callback.message.edit_text(
            "üìã –£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π.\n\n"
            "–•–æ—Ç–∏—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ?",
            reply_markup=InlineKeyboardMarkup(inline_keyboard=[
                [InlineKeyboardButton(text="‚ûï –î–æ–±–∞–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ", callback_data="add_reminder")],
                [InlineKeyboardButton(text="üîô –ù–∞–∑–∞–¥", callback_data="show_cabinet")]
            ])
        )
        return

    reminders_text = "‚è∞ *–í–∞—à–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è:*\n\n"

    for i, reminder in enumerate(reminders, 1):
        status = "‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ" if reminder['sent'] else "‚è≥ –û–∂–∏–¥–∞–µ—Ç"
        reminders_text += (
            f"{i}. {reminder['text']}\n"
            f"   üìÖ {reminder['due_date']}\n"
            f"   {status}\n\n"
        )

    await callback.message.edit_text(
        reminders_text,
        parse_mode="Markdown",
        reply_markup=InlineKeyboardMarkup(inline_keyboard=[
            [InlineKeyboardButton(text="‚ûï –î–æ–±–∞–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ", callback_data="add_reminder")],
            [InlineKeyboardButton(text="üîô –í –∫–∞–±–∏–Ω–µ—Ç", callback_data="show_cabinet")]
        ])
    )
    await callback.answer()


@user_router.callback_query(F.data == "show_progress")
async def show_progress(callback: CallbackQuery):
    """–ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å –æ–±—É—á–µ–Ω–∏—è"""
    registrations = db.get_user_registrations(callback.from_user.id)

    if not registrations:
        await callback.message.edit_text(
            "–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞.",
            reply_markup=get_main_keyboard()
        )
        return

    progress_text = "üìä *–í–∞—à –ø—Ä–æ–≥—Ä–µ—Å—Å:*\n\n"

    for reg in registrations:
        progress_value = getattr(reg, 'progress', 0.0) or 0.0
        attendance_value = getattr(reg, 'attendance', 0) or 0
        grade_value = getattr(reg, 'grade', '–ù–µ—Ç –æ—Ü–µ–Ω–∫–∏')

        progress_text += (
            f"üìö *{reg.course}*\n"
            f"üìà –ü—Ä–æ–≥—Ä–µ—Å—Å: {progress_value:.1f}%\n"
            f"üìÖ –ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å: {attendance_value} –∑–∞–Ω—è—Ç–∏–π\n"
        )

        if grade_value and grade_value != '–ù–µ—Ç –æ—Ü–µ–Ω–∫–∏':
            progress_text += f"‚≠ê –û—Ü–µ–Ω–∫–∞: {grade_value}\n"

        progress_text += "\n"

    await callback.message.edit_text(
        progress_text,
        parse_mode="Markdown",
        reply_markup=get_progress_keyboard()
    )
    await callback.answer()


@user_router.callback_query(F.data == "start_quiz")
async def start_quiz(callback: CallbackQuery, state: FSMContext):
    """–ù–∞—á–∞—Ç—å —Ç–µ—Å—Ç/–≤–∏–∫—Ç–æ—Ä–∏–Ω—É"""
    registrations = db.get_user_registrations(callback.from_user.id)

    if not registrations:
        await callback.message.edit_text(
            "‚ùå –£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫—É—Ä—Å–æ–≤ –¥–ª—è –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è —Ç–µ—Å—Ç–∞.",
            reply_markup=get_main_keyboard()
        )
        return

    course = registrations[0].course

    if course not in config.QUIZZES:
        await callback.message.edit_text(
            f"‚ùå –î–ª—è –∫—É—Ä—Å–∞ '{course}' –ø–æ–∫–∞ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤.",
            reply_markup=get_cabinet_keyboard(has_registrations=True)
        )
        return

    # –ù–∞—á–∏–Ω–∞–µ–º —Ç–µ—Å—Ç —Å –ø–µ—Ä–≤–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞
    await state.update_data(
        quiz_course=course,
        quiz_index=0,
        quiz_correct=0,
        quiz_total=len(config.QUIZZES[course])
    )

    await show_quiz_question(callback.message, state, 0, course)
    await callback.answer()


async def show_quiz_question(message, state: FSMContext, question_index: int, course: str):
    """–ü–æ–∫–∞–∑–∞—Ç—å –≤–æ–ø—Ä–æ—Å —Ç–µ—Å—Ç–∞"""
    questions = config.QUIZZES[course]

    if question_index >= len(questions):
        # –¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω
        data = await state.get_data()
        correct = data.get('quiz_correct', 0)
        total = data.get('quiz_total', 0)
        percentage = (correct / total * 100) if total > 0 else 0

        result_text = (
            f"üéâ *–¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω!*\n\n"
            f"‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤: {correct} –∏–∑ {total}\n"
            f"üìä –†–µ–∑—É–ª—å—Ç–∞—Ç: {percentage:.1f}%\n\n"
        )

        if percentage >= 80:
            result_text += "üåü –û—Ç–ª–∏—á–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç!"
        elif percentage >= 60:
            result_text += "üëç –•–æ—Ä–æ—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç!"
        else:
            result_text += "üìö –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª"

        await message.edit_text(
            result_text,
            parse_mode="Markdown",
            reply_markup=get_quiz_results_keyboard()
        )
        await state.clear()
        return

    question = questions[question_index]

    question_text = (
        f"‚ùì *–í–æ–ø—Ä–æ—Å {question_index + 1} –∏–∑ {len(questions)}*\n\n"
        f"{question['question']}"
    )

    await message.edit_text(
        question_text,
        parse_mode="Markdown",
        reply_markup=get_quiz_question_keyboard(question_index, question['options'], course)
    )


@user_router.callback_query(F.data.startswith("quiz_"))
async def handle_quiz_answer(callback: CallbackQuery, state: FSMContext):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –≤–æ–ø—Ä–æ—Å —Ç–µ—Å—Ç–∞"""

    if callback.data == "cancel_quiz":
        await state.clear()
        await callback.message.edit_text(
            "‚ùå –¢–µ—Å—Ç –ø—Ä–µ—Ä–≤–∞–Ω.",
            reply_markup=get_cabinet_keyboard(has_registrations=True)
        )
        await callback.answer()
        return

    try:
        parts = callback.data.split("_")
        question_index = int(parts[1])
        answer_index = int(parts[2])

        data = await state.get_data()
        course = data['quiz_course']
        correct_count = data.get('quiz_correct', 0)

        questions = config.QUIZZES[course]
        question = questions[question_index]

        is_correct = (answer_index == question['answer'])

        if is_correct:
            correct_count += 1
            await state.update_data(quiz_correct=correct_count)
            result_emoji = "‚úÖ"
            result_text = "–ü—Ä–∞–≤–∏–ª—å–Ω–æ!"
        else:
            result_emoji = "‚ùå"
            result_text = f"–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ. –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: {question['options'][question['answer']]}"

        explanation_text = (
            f"{result_emoji} *{result_text}*\n\n"
            f"üí° {question['explanation']}"
        )

        await callback.answer(result_text, show_alert=True)

        # –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –≤–æ–ø—Ä–æ—Å—É
        next_index = question_index + 1

        await callback.message.edit_text(explanation_text, parse_mode="Markdown")
        await asyncio.sleep(2)

        await show_quiz_question(callback.message, state, next_index, course)

    except Exception as e:
        logger.error(f"Error in quiz handler: {e}")
        await callback.answer("‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—Ç–≤–µ—Ç–∞")


# –û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å
@user_router.callback_query(F.data == "give_feedback")
async def start_feedback(callback: CallbackQuery, state: FSMContext):
    """–ù–∞—á–∞–ª–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏"""
    registrations = db.get_user_registrations(callback.from_user.id)

    if not registrations:
        await callback.message.edit_text(
            "–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π –¥–ª—è –æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è –æ—Ç–∑—ã–≤–∞.",
            reply_markup=get_main_keyboard()
        )
        return

    await state.set_state(FeedbackStates.waiting_for_feedback_text)
    await state.update_data(
        user_id=callback.from_user.id,
        user_name=callback.from_user.full_name,
        registrations=registrations
    )

    await callback.message.edit_text(
        "üìù *–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å*\n\n"
        "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –æ–±—Ä–∞—â–µ–Ω–∏—è:",
        parse_mode="Markdown",
        reply_markup=get_feedback_types_keyboard()
    )
    await callback.answer()


@user_router.callback_query(F.data.startswith("feedback_type_"))
async def choose_feedback_type(callback: CallbackQuery, state: FSMContext):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏"""
    feedback_type = callback.data.replace("feedback_type_", "")
    logger.debug(f"Feedback type received: {feedback_type}")

    type_names = {
        "review": "–æ—Ç–∑—ã–≤",
        "suggestion": "–ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é",
        "issue": "—Å–æ–æ–±—â–µ–Ω–∏–µ –æ –ø—Ä–æ–±–ª–µ–º–µ"
    }

    if feedback_type not in type_names:
        await callback.message.edit_text(
            "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ç–∏–ø –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Å–Ω–æ–≤–∞.",
            reply_markup=get_feedback_types_keyboard()
        )
        await callback.answer()
        return

    await state.update_data(feedback_type=feedback_type)

    if feedback_type == "review":
        await state.set_state(FeedbackStates.waiting_for_rating)
        await callback.message.edit_text(
            "‚≠ê *–û—Ü–µ–Ω–∏—Ç–µ –Ω–∞—à –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π —Ü–µ–Ω—Ç—Ä*\n\n"
            "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –æ—Ü–µ–Ω–∫—É –æ—Ç 1 –¥–æ 5 –∑–≤–µ–∑–¥:",
            parse_mode="Markdown",
            reply_markup=get_rating_keyboard()
        )
    else:
        await state.set_state(FeedbackStates.waiting_for_feedback_text)
        prompt_text = {
            "suggestion": "üí° *–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é*\n\n–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–ø–∏—à–∏—Ç–µ –≤–∞—à–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ:",
            "issue": "üêû *–°–æ–æ–±—â–µ–Ω–∏–µ –æ –ø—Ä–æ–±–ª–µ–º–µ*\n\n–û–ø–∏—à–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–∑–Ω–∏–∫—à—É—é –ø—Ä–æ–±–ª–µ–º—É:"
        }
        await callback.message.edit_text(
            prompt_text[feedback_type],
            parse_mode="Markdown",
            reply_markup=get_cancel_keyboard()
        )
    await callback.answer()


@user_router.callback_query(F.data.startswith("rating_"), FeedbackStates.waiting_for_rating)
async def get_rating(callback: CallbackQuery, state: FSMContext):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –æ—Ü–µ–Ω–∫–∏"""
    rating = int(callback.data.replace("rating_", ""))
    await state.update_data(rating=rating)
    await state.set_state(FeedbackStates.waiting_for_feedback_text)

    await callback.message.edit_text(
        "üìù *–ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –æ—Ç–∑—ã–≤*\n\n"
        f"–í—ã –≤—ã–±—Ä–∞–ª–∏ –æ—Ü–µ–Ω–∫—É: {rating}‚≠ê\n"
        "–¢–µ–ø–µ—Ä—å –Ω–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –æ—Ç–∑—ã–≤ –æ –Ω–∞—à–µ–º –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω–æ–º —Ü–µ–Ω—Ç—Ä–µ:",
        parse_mode="Markdown",
        reply_markup=get_cancel_keyboard()
    )
    await callback.answer()


@user_router.message(FeedbackStates.waiting_for_feedback_text)
async def get_feedback_text(message: Message, state: FSMContext):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏"""
    if message.text == "‚ùå –û—Ç–º–µ–Ω–∞":
        await state.clear()
        await message.answer("–û—Ç–º–µ–Ω–µ–Ω–æ.", reply_markup=get_main_keyboard())
        return

    data = await state.get_data()
    feedback_text = message.text

    await state.update_data(feedback_text=feedback_text)

    type_names = {
        "review": "–û—Ç–∑—ã–≤",
        "suggestion": "–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é",
        "issue": "–°–æ–æ–±—â–µ–Ω–∏–µ –æ –ø—Ä–æ–±–ª–µ–º–µ"
    }

    confirmation_text = f"üìã *–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–∞—à–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ:*\n\n"
    confirmation_text += f"üìù *–¢–∏–ø:* {type_names[data['feedback_type']]}\n"

    if data['feedback_type'] == 'review':
        confirmation_text += f"‚≠ê *–û—Ü–µ–Ω–∫–∞:* {data['rating']}/5\n"

    confirmation_text += f"üìÑ *–¢–µ–∫—Å—Ç:*\n{feedback_text}\n\n"
    confirmation_text += "–í—Å—ë –≤–µ—Ä–Ω–æ?"

    await message.answer(
        confirmation_text,
        parse_mode="Markdown",
        reply_markup=get_feedback_confirmation_keyboard()
    )


@user_router.callback_query(F.data == "feedback_send")
async def send_feedback(callback: CallbackQuery, state: FSMContext):
    """–û—Ç–ø—Ä–∞–≤–∫–∞ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏"""
    data = await state.get_data()

    success = db.save_feedback(
        user_id=data['user_id'],
        user_name=data['user_name'],
        feedback_type=data['feedback_type'],
        feedback_text=data['feedback_text'],
        rating=data.get('rating', None),
        created_at=datetime.datetime.now()
    )

    if success:
        await send_feedback_to_admins(callback.bot, data)

        await callback.message.edit_text(
            "‚úÖ *–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à—É –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å!*\n\n"
            "–ú—ã —Ü–µ–Ω–∏–º –≤–∞—à–µ –º–Ω–µ–Ω–∏–µ –∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Ä–∞—Å—Å–º–æ—Ç—Ä–∏–º –≤–∞—à–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ.",
            parse_mode="Markdown",
            reply_markup=get_main_keyboard()
        )
    else:
        await callback.message.edit_text(
            "‚ùå *–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –æ—Ç–∑—ã–≤–∞.*\n\n"
            "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.",
            parse_mode="Markdown",
            reply_markup=get_main_keyboard()
        )

    await state.clear()
    await callback.answer()


@user_router.callback_query(F.data.in_(["feedback_review", "feedback_suggestion", "feedback_issue"]))
async def handle_feedback_type_selection(callback: CallbackQuery, state: FSMContext):
    feedback_types = {
        "feedback_review": "review",
        "feedback_suggestion": "suggestion",
        "feedback_issue": "issue"
    }

    feedback_type = feedback_types[callback.data]
    await state.update_data(feedback_type=feedback_type)

    if feedback_type == "review":
        await state.set_state(FeedbackStates.waiting_for_rating)
        await callback.message.edit_text(
            "‚≠ê –û—Ü–µ–Ω–∏—Ç–µ –Ω–∞—à —Ü–µ–Ω—Ç—Ä (1-5 –∑–≤–µ–∑–¥):",
            reply_markup=get_rating_keyboard()
        )
    else:
        await state.set_state(FeedbackStates.waiting_for_feedback_text)
        prompt = "üí° –û–ø–∏—à–∏—Ç–µ –≤–∞—à–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ:" if feedback_type == "suggestion" else "üêû –û–ø–∏—à–∏—Ç–µ –ø—Ä–æ–±–ª–µ–º—É:"
        await callback.message.edit_text(prompt, reply_markup=get_cancel_keyboard())


@user_router.callback_query(F.data == "feedback_edit")
async def edit_feedback(callback: CallbackQuery, state: FSMContext):
    """–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏"""
    await state.set_state(FeedbackStates.waiting_for_feedback_text)

    await callback.message.edit_text(
        "üìù *–ò—Å–ø—Ä–∞–≤—å—Ç–µ –≤–∞—à —Ç–µ–∫—Å—Ç:*\n\n"
        "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–ø–∏—à–∏—Ç–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç:",
        parse_mode="Markdown",
        reply_markup=get_cancel_keyboard()
    )
    await callback.answer()


async def send_feedback_to_admins(bot, feedback_data):
    """–û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–æ–≤–æ–π –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º"""
    try:
        type_names = {
            "review": "üìù –ù–û–í–´–ô –û–¢–ó–´–í",
            "suggestion": "üí° –ù–û–í–û–ï –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï",
            "issue": "üêû –°–û–û–ë–©–ï–ù–ò–ï –û –ü–†–û–ë–õ–ï–ú–ï"
        }

        message_text = (
            f"{type_names[feedback_data['feedback_type']]}\n\n"
            f"üë§ *–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:* {feedback_data['user_name']}\n"
            f"üÜî *ID:* {feedback_data['user_id']}\n"
        )

        if feedback_data['feedback_type'] == 'review':
            message_text += f"‚≠ê *–û—Ü–µ–Ω–∫–∞:* {feedback_data['rating']}/5\n"

        message_text += f"üìÑ *–¢–µ–∫—Å—Ç:*\n{feedback_data['feedback_text']}\n\n"
        message_text += f"üïí *–í—Ä–µ–º—è:* {datetime.datetime.now().strftime('%d.%m.%Y %H:%M')}"

        for admin_id in config.ADMIN_IDS:
            try:
                await bot.send_message(admin_id, message_text, parse_mode="Markdown")
            except aiogram.exceptions.TelegramBadRequest as e:
                logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É {admin_id}: {e}")
            except aiogram.exceptions.TelegramForbiddenError as e:
                logger.warning(f"‚ùå –ë–æ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º {admin_id}: {e}")
            except Exception as e:
                logger.error(f"‚ùå –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É {admin_id}: {e}")

    except KeyError as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤ –¥–∞–Ω–Ω—ã—Ö –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏: {e}")
    except Exception as e:
        logger.error(f"‚ùå –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: {e}")


# –û–±—â–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
@user_router.callback_query(F.data == "cancel")
async def cancel_action(callback: CallbackQuery, state: FSMContext):
    """–û—Ç–º–µ–Ω–∞ –¥–µ–π—Å—Ç–≤–∏—è"""
    await state.clear()

    await callback.message.edit_text(
        "‚ùå –û—Ç–º–µ–Ω–µ–Ω–æ",
        reply_markup=get_main_keyboard()
    )
    await callback.answer()


@user_router.callback_query(F.data == "back_to_main")
async def back_to_main(callback: CallbackQuery, state: FSMContext):
    """–í–æ–∑–≤—Ä–∞—Ç –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"""
    await state.clear()

    try:
        await callback.message.edit_text(
            "üè† *–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é*\n\n–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
            parse_mode="Markdown",
            reply_markup=get_main_keyboard()
        )
    except aiogram.exceptions.TelegramBadRequest:
        await callback.message.answer(
            "üè† *–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é*\n\n–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
            parse_mode="Markdown",
            reply_markup=get_main_keyboard()
        )

    await callback.answer()


@user_router.callback_query(F.data == "about_center")
async def about_center(callback: CallbackQuery):
    """–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ü–µ–Ω—Ç—Ä–µ"""
    about_text = (
        "üè´ *–û –Ω–∞—à–µ–º –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω–æ–º —Ü–µ–Ω—Ç—Ä–µ*\n\n"
        "–ú—ã –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –ø–æ —Ä–∞–∑–ª–∏—á–Ω—ã–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º.\n\n"
        "üìû *–ö–æ–Ω—Ç–∞–∫—Ç—ã:*\n"
        "–¢–µ–ª–µ—Ñ–æ–Ω: +998 XX XXX-XX-XX\n"
        "Email: info@example.com\n"
        "–ê–¥—Ä–µ—Å: –≥. –¢–∞—à–∫–µ–Ω—Ç, —É–ª. ...\n\n"
        "üïí *–ß–∞—Å—ã —Ä–∞–±–æ—Ç—ã:*\n"
        "–ü–Ω-–ü—Ç: 9:00-18:00\n"
        "–°–±: 10:00-15:00\n"
        "–í—Å: –≤—ã—Ö–æ–¥–Ω–æ–π"
    )

    await callback.message.edit_text(
        about_text,
        parse_mode="Markdown",
        reply_markup=get_back_keyboard("back_to_main")
    )
    await callback.answer()


@user_router.callback_query(F.data == "show_courses")
async def show_courses(callback: CallbackQuery):
    """–ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ –∫—É—Ä—Å–æ–≤"""
    courses_text = "üéì *–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫—É—Ä—Å—ã:*\n\n"

    for course, types_dict in config.COURSES.items():
        courses_text += f"*{course}:*\n"
        for training_type, price in types_dict.items():
            courses_text += f"  ‚Ä¢ {training_type}: {price}\n"
        courses_text += "\n"

    await callback.message.edit_text(
        courses_text,
        parse_mode="Markdown",
        reply_markup=get_back_keyboard("back_to_main")
    )
    await callback.answer()

    @user_router.callback_query(F.data == "my_registrations")
    async def show_my_registrations(callback: CallbackQuery):
        """–ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ –∑–∞–ø–∏—Å–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        try:
            # –ü–æ–ª—É—á–∞–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞–ø—Ä—è–º—É—é –ø–æ telegram_id
            registrations = db.get_user_registrations(callback.from_user.id)

            if not registrations:
                await callback.message.edit_text(
                    "üìù *–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π –Ω–∞ –∫—É—Ä—Å—ã*\n\n"
                    "–•–æ—Ç–∏—Ç–µ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫—É—Ä—Å?",
                    parse_mode="Markdown",
                    reply_markup=InlineKeyboardMarkup(inline_keyboard=[
                        [InlineKeyboardButton(text="üìù –ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫—É—Ä—Å", callback_data="new_registration")],
                        [InlineKeyboardButton(text="‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data="show_cabinet")]
                    ])
                )
            else:
                text = "üìã *–í–∞—à–∏ –∑–∞–ø–∏—Å–∏ –Ω–∞ –∫—É—Ä—Å—ã:*\n\n"

                for idx, reg in enumerate(registrations, 1):
                    status_emoji = {
                        'active': 'üü¢',
                        'trial': 'üü°',
                        'studying': 'üîµ',
                        'frozen': '‚ö™',
                        'waiting_payment': 'üü†',
                        'completed': 'üü£'
                    }.get(reg.status, '‚ö´')

                    status_text = config.STATUSES.get(reg.status, reg.status)

                    text += (
                        f"*{idx}. {reg.course}* {status_emoji}\n"
                        f"   üìä –¢–∏–ø: {reg.training_type}\n"
                        f"   ‚è∞ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ: {reg.schedule}\n"
                        f"   üìå –°—Ç–∞—Ç—É—Å: {status_text}\n\n"
                    )

                await callback.message.edit_text(
                    text,
                    parse_mode="Markdown",
                    reply_markup=get_registrations_keyboard(registrations)
                )

            await callback.answer()

        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≤ show_my_registrations: {e}", exc_info=True)
            await callback.message.edit_text(
                "‚ùå *–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞*\n\n"
                "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∑–∞–ø–∏—Å–µ–π. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.",
                parse_mode="Markdown",
                reply_markup=get_cabinet_keyboard()
            )
            await callback.answer()

    @user_router.callback_query(F.data.startswith("registration_detail_"))
    async def show_registration_detail(callback: CallbackQuery):
        """‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏"""
        try:
            # –ò–∑–≤–ª–µ–∫–∞–µ–º ID —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
            reg_id = int(callback.data.replace("registration_detail_", ""))

            # –ü–æ–ª—É—á–∞–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é (‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ê –ó–ê–ö–†–´–í–ê–Æ–©–ê–Ø –°–ö–û–ë–ö–ê)
            registration = db.get_registration_by_id(reg_id)

            if not registration:
                await callback.message.edit_text(
                    "‚ùå –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞",
                    reply_markup=get_back_keyboard("my_registrations", "‚óÄÔ∏è –ö —Å–ø–∏—Å–∫—É –∑–∞–ø–∏—Å–µ–π")
                )
                await callback.answer()
                return

            # –§–æ—Ä–º–∏—Ä—É–µ–º –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
            status_emoji = {
                'active': 'üü¢',
                'trial': 'üü°',
                'studying': 'üîµ',
                'frozen': '‚ö™',
                'waiting_payment': 'üü†',
                'completed': 'üü£'
            }.get(registration.status, '‚ö´')

            status_text = config.STATUSES.get(registration.status, registration.status)

            detail_text = (
                f"üìã *–î–µ—Ç–∞–ª–∏ –∑–∞–ø–∏—Å–∏* {status_emoji}\n\n"
                f"üéì *–ö—É—Ä—Å:* {registration.course}\n"
                f"üìä *–¢–∏–ø –æ–±—É—á–µ–Ω–∏—è:* {registration.training_type}\n"
                f"‚è∞ *–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ:* {registration.schedule}\n"
                f"üí∞ *–°—Ç–æ–∏–º–æ—Å—Ç—å:* {registration.price}\n"
                f"üìå *–°—Ç–∞—Ç—É—Å:* {status_text}\n"
            )

            if registration.created_at:
                detail_text += f"üìÖ *–î–∞—Ç–∞ –∑–∞–ø–∏—Å–∏:* {registration.created_at.strftime('%d.%m.%Y %H:%M')}\n"

            await callback.message.edit_text(
                detail_text,
                parse_mode="Markdown",
                reply_markup=get_registration_detail_keyboard(registration.id)
            )
            await callback.answer()

        except ValueError:
            logger.error(f"–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç ID –≤ registration_detail: {callback.data}")
            await callback.answer("‚ùå –û—à–∏–±–∫–∞: –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö", show_alert=True)
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≤ show_registration_detail: {e}", exc_info=True)
            await callback.message.edit_text(
                "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏",
                reply_markup=get_back_keyboard("my_registrations", "‚óÄÔ∏è –ö —Å–ø–∏—Å–∫—É –∑–∞–ø–∏—Å–µ–π")
            )
            await callback.answer()

    @user_router.callback_query(F.data == "show_materials")
    async def show_my_materials(callback: CallbackQuery):
        """‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ü–æ–∫–∞–∑–∞—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª—ã –∫—É—Ä—Å–æ–≤"""
        try:
            # –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ê –ó–ê–ö–†–´–í–ê–Æ–©–ê–Ø –°–ö–û–ë–ö–ê)
            user = db.get_user_by_telegram_id(callback.from_user.id)

            if not user:
                await callback.message.edit_text(
                    "‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω",
                    reply_markup=get_cabinet_keyboard()
                )
                await callback.answer()
                return

            # –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            registrations = db.get_registrations_by_user_id(user.id)
            active_registrations = [r for r in registrations if r.status in ['active', 'studying']]

            if not active_registrations:
                await callback.message.edit_text(
                    "üìö *–ú–∞—Ç–µ—Ä–∏–∞–ª—ã –∫—É—Ä—Å–æ–≤*\n\n"
                    "–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫—É—Ä—Å–æ–≤.\n"
                    "–ó–∞–ø–∏—à–∏—Ç–µ—Å—å –Ω–∞ –∫—É—Ä—Å, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º!",
                    parse_mode="Markdown",
                    reply_markup=InlineKeyboardMarkup(inline_keyboard=[
                        [InlineKeyboardButton(text="üìù –ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫—É—Ä—Å", callback_data="new_registration")],
                        [InlineKeyboardButton(text="‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data="show_cabinet")]
                    ])
                )
                await callback.answer()
                return

            # –°–æ–±–∏—Ä–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∫—É—Ä—Å—ã
            courses = list(set([r.course for r in active_registrations]))

            # –§–æ—Ä–º–∏—Ä—É–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º–∏
            buttons = []

            for course in courses:
                if course in config.MATERIALS:
                    materials = config.MATERIALS[course]

                    # –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∫—É—Ä—Å–∞
                    buttons.append([InlineKeyboardButton(
                        text=f"üìö {course}",
                        callback_data=f"materials_course_{course}"
                    )])

                    # –î–æ–±–∞–≤–ª—è–µ–º —Å—Å—ã–ª–∫–∏ –Ω–∞ –º–∞—Ç–µ—Ä–∏–∞–ª—ã
                    for title, url in materials.items():
                        buttons.append([InlineKeyboardButton(text=f"  üìÑ {title}", url=url)])

            buttons.append([InlineKeyboardButton(text="‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data="show_cabinet")])

            await callback.message.edit_text(
                "üìö *–ú–∞—Ç–µ—Ä–∏–∞–ª—ã –≤–∞—à–∏—Ö –∫—É—Ä—Å–æ–≤:*\n\n"
                "–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ç–µ—Ä–∏–∞–ª –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞:",
                parse_mode="Markdown",
                reply_markup=InlineKeyboardMarkup(inline_keyboard=buttons)
            )
            await callback.answer()

        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≤ show_my_materials: {e}", exc_info=True)
            await callback.message.edit_text(
                "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤",
                reply_markup=get_cabinet_keyboard()
            )
            await callback.answer()

    @user_router.callback_query(F.data == "show_progress")
    async def show_my_progress(callback: CallbackQuery):
        """‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å –æ–±—É—á–µ–Ω–∏—è"""
        try:
            # –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ê –ó–ê–ö–†–´–í–ê–Æ–©–ê–Ø –°–ö–û–ë–ö–ê)
            user = db.get_user_by_telegram_id(callback.from_user.id)

            if not user:
                await callback.message.edit_text(
                    "‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω",
                    reply_markup=get_cabinet_keyboard()
                )
                await callback.answer()
                return

            # –ü–æ–ª—É—á–∞–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
            registrations = db.get_registrations_by_user_id(user.id)

            if not registrations:
                await callback.message.edit_text(
                    "üìä *–í–∞—à –ø—Ä–æ–≥—Ä–µ—Å—Å*\n\n"
                    "–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π –Ω–∞ –∫—É—Ä—Å—ã.\n"
                    "–ó–∞–ø–∏—à–∏—Ç–µ—Å—å –Ω–∞ –∫—É—Ä—Å, —á—Ç–æ–±—ã –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —Å–≤–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å!",
                    parse_mode="Markdown",
                    reply_markup=InlineKeyboardMarkup(inline_keyboard=[
                        [InlineKeyboardButton(text="üìù –ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫—É—Ä—Å", callback_data="new_registration")],
                        [InlineKeyboardButton(text="‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data="show_cabinet")]
                    ])
                )
                await callback.answer()
                return

            # –°–æ–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            total_courses = len(registrations)
            active_courses = len([r for r in registrations if r.status in ['active', 'studying']])
            completed_courses = len([r for r in registrations if r.status == 'completed'])

            progress_text = (
                "üìä *–í–∞—à –ø—Ä–æ–≥—Ä–µ—Å—Å –æ–±—É—á–µ–Ω–∏—è*\n\n"
                f"üìö –í—Å–µ–≥–æ –∫—É—Ä—Å–æ–≤: {total_courses}\n"
                f"üîµ –ê–∫—Ç–∏–≤–Ω—ã—Ö: {active_courses}\n"
                f"üü£ –ó–∞–≤–µ—Ä—à–µ–Ω–æ: {completed_courses}\n\n"
            )

            # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø–æ –∫–∞–∂–¥–æ–º—É –∫—É—Ä—Å—É
            if active_courses > 0:
                progress_text += "*–ê–∫—Ç–∏–≤–Ω—ã–µ –∫—É—Ä—Å—ã:*\n"
                for reg in registrations:
                    if reg.status in ['active', 'studying']:
                        progress_text += f"‚Ä¢ {reg.course} - {config.STATUSES.get(reg.status, reg.status)}\n"

            await callback.message.edit_text(
                progress_text,
                parse_mode="Markdown",
                reply_markup=get_progress_keyboard()
            )
            await callback.answer()

        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≤ show_my_progress: {e}", exc_info=True)
            await callback.message.edit_text(
                "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞",
                reply_markup=get_cabinet_keyboard()
            )
            await callback.answer()

    @user_router.callback_query(F.data == "my_schedule")
    async def show_my_schedule(callback: CallbackQuery):
        """‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ü–æ–∫–∞–∑–∞—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∑–∞–Ω—è—Ç–∏–π"""
        try:
            # –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ê –ó–ê–ö–†–´–í–ê–Æ–©–ê–Ø –°–ö–û–ë–ö–ê)
            user = db.get_user_by_telegram_id(callback.from_user.id)

            if not user:
                await callback.message.edit_text(
                    "‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω",
                    reply_markup=get_cabinet_keyboard()
                )
                await callback.answer()
                return

            # –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
            registrations = db.get_registrations_by_user_id(user.id)
            active_registrations = [r for r in registrations if r.status in ['active', 'studying']]

            if not active_registrations:
                await callback.message.edit_text(
                    "üìÖ *–í–∞—à–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ*\n\n"
                    "–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫—É—Ä—Å–æ–≤.\n"
                    "–ó–∞–ø–∏—à–∏—Ç–µ—Å—å –Ω–∞ –∫—É—Ä—Å, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ!",
                    parse_mode="Markdown",
                    reply_markup=InlineKeyboardMarkup(inline_keyboard=[
                        [InlineKeyboardButton(text="üìù –ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫—É—Ä—Å", callback_data="new_registration")],
                        [InlineKeyboardButton(text="‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data="show_cabinet")]
                    ])
                )
                await callback.answer()
                return

            # –§–æ—Ä–º–∏—Ä—É–µ–º —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ
            schedule_text = "üìÖ *–í–∞—à–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∑–∞–Ω—è—Ç–∏–π:*\n\n"

            for idx, reg in enumerate(active_registrations, 1):
                schedule_text += (
                    f"*{idx}. {reg.course}*\n"
                    f"   ‚è∞ {reg.schedule}\n"
                    f"   üìä {reg.training_type}\n\n"
                )

            await callback.message.edit_text(
                schedule_text,
                parse_mode="Markdown",
                reply_markup=get_back_keyboard("show_cabinet")
            )
            await callback.answer()

        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≤ show_my_schedule: {e}", exc_info=True)
            await callback.message.edit_text(
                "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è",
                reply_markup=get_cabinet_keyboard()
            )
            await callback.answer()

    @user_router.callback_query(F.data == "start_quiz")
    async def show_quiz_menu(callback: CallbackQuery):
        """‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ü–æ–∫–∞–∑–∞—Ç—å –º–µ–Ω—é —Ç–µ—Å—Ç–æ–≤"""
        try:
            # –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ê –ó–ê–ö–†–´–í–ê–Æ–©–ê–Ø –°–ö–û–ë–ö–ê)
            user = db.get_user_by_telegram_id(callback.from_user.id)

            if not user:
                await callback.message.edit_text(
                    "‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω",
                    reply_markup=get_cabinet_keyboard()
                )
                await callback.answer()
                return

            # –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –∫—É—Ä—Å—ã
            registrations = db.get_registrations_by_user_id(user.id)
            active_registrations = [r for r in registrations if r.status in ['active', 'studying']]

            if not active_registrations:
                await callback.message.edit_text(
                    "üéØ *–¢–µ—Å—Ç—ã –∏ –≤–∏–∫—Ç–æ—Ä–∏–Ω—ã*\n\n"
                    "–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫—É—Ä—Å–æ–≤.\n"
                    "–ó–∞–ø–∏—à–∏—Ç–µ—Å—å –Ω–∞ –∫—É—Ä—Å, —á—Ç–æ–±—ã –ø—Ä–æ—Ö–æ–¥–∏—Ç—å —Ç–µ—Å—Ç—ã!",
                    parse_mode="Markdown",
                    reply_markup=InlineKeyboardMarkup(inline_keyboard=[
                        [InlineKeyboardButton(text="üìù –ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫—É—Ä—Å", callback_data="new_registration")],
                        [InlineKeyboardButton(text="‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data="show_cabinet")]
                    ])
                )
                await callback.answer()
                return

            # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ –∫—É—Ä—Å–æ–≤ —Å —Ç–µ—Å—Ç–∞–º–∏
            buttons = []
            has_quizzes = False

            for reg in active_registrations:
                if reg.course in config.QUIZZES:
                    has_quizzes = True
                    buttons.append([InlineKeyboardButton(
                        text=f"üéØ {reg.course}",
                        callback_data=f"quiz_course_{reg.course}"
                    )])

            if not has_quizzes:
                await callback.message.edit_text(
                    "üéØ *–¢–µ—Å—Ç—ã –∏ –≤–∏–∫—Ç–æ—Ä–∏–Ω—ã*\n\n"
                    "–î–ª—è –≤–∞—à–∏—Ö –∫—É—Ä—Å–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤.",
                    parse_mode="Markdown",
                    reply_markup=get_back_keyboard("show_cabinet")
                )
            else:
                buttons.append([InlineKeyboardButton(text="‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data="show_cabinet")])

                await callback.message.edit_text(
                    "üéØ *–í—ã–±–µ—Ä–∏—Ç–µ –∫—É—Ä—Å –¥–ª—è –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è —Ç–µ—Å—Ç–∞:*",
                    parse_mode="Markdown",
                    reply_markup=InlineKeyboardMarkup(inline_keyboard=buttons)
                )

            await callback.answer()

        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≤ show_quiz_menu: {e}", exc_info=True)
            await callback.message.edit_text(
                "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ç–µ—Å—Ç–æ–≤",
                reply_markup=get_cabinet_keyboard()
            )
            await callback.answer()


def register_user_handlers(dp):
    """–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤"""
    dp.include_router(user_router)
